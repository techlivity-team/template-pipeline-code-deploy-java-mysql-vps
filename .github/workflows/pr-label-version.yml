name: PR Label Versioning

on:
  pull_request:
    branches:
      - develop
    types: [opened, synchronize, reopened]

jobs:
  label-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repositÃ³rio
        uses: actions/checkout@v3

      - name: Obter commits do Pull Request
        id: get_commits
        run: |
          echo "ğŸ” Buscando mensagens de commit do PR #${{ github.event.pull_request.number }}..."

          commits=$(gh pr view ${{ github.event.pull_request.number }} --json commits -q ".commits[].message")
          
          echo "ğŸ“ Commits obtidos:"
          echo "$commits"

          echo "COMMITS<<EOF" >> $GITHUB_ENV
          echo "$commits" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Determinar versÃ£o
        id: determine_version
        run: |
          echo "ğŸ” Determinando label de versÃ£o com base nas mensagens dos commits..."
          echo "Commits analisados:"
          echo "${COMMITS}"

          version_label=""
          while read -r line; do
            echo "ğŸ” Analisando commit: $line"
            if [[ "$line" =~ ^feat: ]]; then
              echo "âœ… Detected 'feat:' â€” marcando como version:major"
              version_label="version:major"
              break
            elif [[ "$line" =~ ^(fix|chore): ]]; then
              echo "âœ… Detected 'fix:' ou 'chore:' â€” marcando como version:minor"
              version_label="version:minor"
              # nÃ£o usamos break, pois pode vir um feat depois
            fi
          done <<< "${COMMITS}"
          
          echo "ğŸ·ï¸ Label determinada: $version_label"
          echo "version_label=$version_label" >> $GITHUB_OUTPUT

      - name: Adicionar label ao PR
        if: steps.determine_version.outputs.version_label != ''
        run: |
          echo "ğŸ·ï¸ Adicionando label '${{ steps.determine_version.outputs.version_label }}' ao PR..."
          gh pr edit ${{ github.event.pull_request.number }} --add-label "${{ steps.determine_version.outputs.version_label }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
