name: 3.1 Rollback da Produ√ß√£o

on:
  workflow_dispatch:

jobs:
  rollback:
    name: üîô Rollback para vers√£o anterior
    runs-on: ubuntu-latest

    steps:
      - name: Instalar sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Executar rollback na VPS
        run: |
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} '
              echo "‚û°Ô∏è Encerrando aplica√ß√£o atual..."
              PID=$(lsof -ti:8080)
              if [ -n "$PID" ]; then kill -9 $PID; fi

              echo "üîÅ Restaurando vers√£o anterior..."
              cd /home/ubuntu/production &&
              if [ -f api-teste-mysql-previous.jar ]; then
                cp api-teste-mysql-previous.jar api-teste-mysql-0.0.1-SNAPSHOT.jar &&
                tmux kill-session -t app-prod 2>/dev/null || true &&
                tmux new-session -d -s app-prod "export DATASOURCE_URL=${{ secrets.DATASOURCE_URL }} && \
                                                 export DATASOURCE_USERNAME=${{ secrets.DATASOURCE_USERNAME }} && \
                                                 export DATASOURCE_PASSWORD=${{ secrets.DATASOURCE_PASSWORD }} && \
                                                 java -jar api-teste-mysql-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod"
              else
                echo "‚ö†Ô∏è Nenhuma vers√£o de backup encontrada para rollback."
              fi
            '
